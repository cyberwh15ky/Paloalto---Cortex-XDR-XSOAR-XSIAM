# åå‘é€£ç·šçš„ã€Œæ¨™æº–æ‹“æ’²ã€
[ ä½ åœ¨å®¶ / å¤–éƒ¨ Client ]  
          |  
       Internet  
          |  
   Azure Public IP  (ä¾‹å¦‚ 52.x.x.x)  
          |  
   Azure VM (Linux, Nginx / Reverse Proxy)  
          |  
     IPSec / TLS Tunnel   â† Palo Alto ä¸»å‹•å»ºç«‹  
          |  
     Palo Alto (10.1.129.4)  
          |  
   GlobalProtect Portal / Gateway  

 
# çœŸå¯¦æµé‡è·¯å¾‘  
[ å¤–éƒ¨ Client ]  
        |  
        |  (TCP 443)  
        v  
[ Azure å…¬ç¶² IP ]  
        |  
        |  (åå‘ä»£ç† / ä¸­ç¹¼)  
        v  
[ IPSec / Tunnel ]  
        |  
        |  (Palo Alto ä¸»å‹•å»ºç«‹çš„é€£ç·š)  
        v  
[ Palo Alto NGPW ]  
        |  
        v  
[ GlobalProtect Portal / Gateway ]  



### é—œéµé»
> å¤–éƒ¨æ°¸é åªçœ‹åˆ° Azure å…¬ç¶² IP  
> Palo Alto æ°¸é æ˜¯ å‘å¤–ä¸»å‹•é€£ç·š  
> ä¸å­˜åœ¨ã€Œå¤–éƒ¨æ‰“ä½ å®¶è£¡ã€é€™ä»¶äº‹



### å¯é©—è­‰æ¸…å–®  
  
åªè¦ä¸‹é¢ 5 æ¢å…¨éƒ¨æˆç«‹ï¼Œå°±ç™¾åˆ†ä¹‹ç™¾æˆåŠŸï¼š  
  
1ï¸âƒ£ Palo Alto èƒ½ ping Azure VM çš„ tunnel IP  
2ï¸âƒ£ Azure VM èƒ½ ping 10.1.129.4ï¼ˆé€é tunnelï¼‰  
3ï¸âƒ£ Azure VM curl https://10.1.129.4 æœ‰å›æ‡‰  
4ï¸âƒ£ Azure VM 443 å° Internet é–‹æ”¾  
5ï¸âƒ£ å¤–éƒ¨ Client https://Azure_Public_IP èƒ½çœ‹åˆ° GP Portal  
  
ğŸ‘‰ 5/5 = æˆåŠŸ  
ğŸ‘‰ 4/5 = ä¸€å®šèƒ½ä¿®åˆ°æˆåŠŸ  








å¾ˆå¥½ï¼Œé€™ä¸€é¡Œæˆ‘æœƒ**åªåšä¸€ä»¶äº‹**ï¼š
ğŸ‘‰ **æŠŠã€Œåå‘é€£ç·šï¼ˆReverse Accessï¼‰ã€ç”¨ã€ŒçœŸå¯¦æµé‡è·¯å¾‘ã€çš„è§’åº¦ï¼Œçµ¦ä½ ä¸€å¥—ã€Œå¯ç…§æŠ„ã€å¯é©—è­‰ã€ä¸€å®šé€šã€çš„æ“ä½œæ•™å­¸**ã€‚
ä¸å†æŠ½è±¡ã€ä¸å†å¤šæ–¹æ¡ˆï¼Œåªç•™ **ä¸€æ¢ç©©å®šå·¥ç¨‹è§£æ³•**ã€‚

---

# ğŸ¯ ç›®æ¨™ï¼ˆå…ˆå°é½Šï¼‰

ä½ è¦é”æˆçš„æ˜¯ï¼š

> **å¤–éƒ¨ä»»æ„ç¶²è·¯ï¼ˆå®¶è£¡ / 4G / å…¬å¸ï¼‰
> å¯ä»¥é€£åˆ°
> Azure å…¬ç¶² IP
> ä¸¦æœ€çµ‚é€²å…¥
> ä½ å®¶è£¡çš„ Palo Alto NGPW çš„ GlobalProtect Portal / Gateway**

è€Œä¸”ï¼š

* âŒ ä¸éœ€è¦ä½ å®¶æœ‰å…¬ç¶² IP
* âŒ ä¸éœ€è¦ Port Forward
* âŒ ä¸æ€• CGNAT
* âœ… Palo Alto åªè¦ã€Œä¸»å‹•å°å¤–ã€

---

# ğŸ§  çœŸå¯¦æµé‡è·¯å¾‘ï¼ˆè«‹å…ˆè¨˜ä½é€™å€‹ï¼‰

```
[ å¤–éƒ¨ Client ]
        |
        |  TCP 443
        v
[ Azure å…¬ç¶² IP ]
        |
        |  TCP Proxy (Nginx / HAProxy)
        v
[ IPSec Tunnel ]
        |
        |  å·²å»ºç«‹çš„åå‘é€šé“ï¼ˆPalo Alto ä¸»å‹•ï¼‰
        v
[ Palo Alto ethernet1/1 (10.1.129.4) ]
        |
        v
[ GlobalProtect Portal / Gateway ]
```

> âš ï¸ é‡é»ï¼š
> **å¤–éƒ¨æµé‡æ°¸é ä¸æœƒã€Œä¸»å‹•æ‰“é€²ä½ å®¶ã€**
> å®ƒåªæ‰“åˆ° Azure

---

# ğŸ§© æ¶æ§‹å…ƒä»¶ï¼ˆåªéœ€è¦ 3 å€‹ï¼‰

1ï¸âƒ£ Azure VMï¼ˆæœ‰å…¬ç¶² IPï¼‰
2ï¸âƒ£ Palo Altoï¼ˆä½ å·²æœ‰ï¼‰
3ï¸âƒ£ IPSec Site-to-Site VPNï¼ˆåå‘é€šé“ï¼‰

---

# ğŸ› ï¸ å¯¦ä½œæ•™å­¸ï¼ˆä¸€æ­¥ä¸€æ­¥ï¼Œç…§åšï¼‰

---

## ğŸ”¹ Step 1ï¼šå»ºç«‹ Azure VMï¼ˆå…¬ç¶²å…¥å£ï¼‰

### Azure Portal è¨­å®šé‡é»

* OSï¼šUbuntu 20.04 / 22.04
* Sizeï¼šB1sï¼ˆå¤ ç”¨ï¼‰
* Networkï¼š

  * Public IPï¼šâœ”ï¸
  * NSG Inbound å…è¨±ï¼š

    * TCP **443**
    * UDP **500**
    * UDP **4500**

è¨˜ä¸‹ï¼š

```
Azure å…¬ç¶² IP = <AZURE_PUBLIC_IP>
```

---

## ğŸ”¹ Step 2ï¼šåœ¨ Azure VM å®‰è£ã€Œåå‘ä»£ç†ã€

```bash
sudo apt update
sudo apt install -y nginx
```

å…ˆä¸è¦å•Ÿå‹• proxyï¼Œå¾Œé¢ä¸€èµ·åšã€‚

---

## ğŸ”¹ Step 3ï¼šå»ºç«‹ Palo Alto â†’ Azure çš„ IPSecï¼ˆæ ¸å¿ƒï¼‰

### ğŸ¯ åŸå‰‡

* **Palo Alto = Initiator**
* **Azure = Responder**
* ç©¿è¶Š NAT / CGNAT å®Œå…¨ OK

---

### 3-1ï¸âƒ£ Palo Alto è¨­å®š

#### (A) Tunnel Interface

```
Network > Interfaces > Tunnel
```

* Nameï¼š`tunnel.20`
* Virtual Routerï¼š`default`
* Zoneï¼š`IPSec-Zone`
* IPv4ï¼š`10.10.10.1/30`

---

#### (B) IKE Gateway

```
Network > IKE Gateways
```

* Versionï¼šIKEv2
* Remote Peer Addressï¼š`<AZURE_PUBLIC_IP>`
* Authenticationï¼šPre-Shared Key
* Local IDï¼š`paloalto`
* NAT Traversalï¼šEnable

---

#### (C) IPSec Tunnel

```
Network > IPSec Tunnels
```

* Tunnel Interfaceï¼š`tunnel.20`
* IKE Gatewayï¼šä¸Šé¢é‚£å€‹
* Proxy-IDï¼š

  * Localï¼š`10.1.129.4/32`
  * Remoteï¼š`10.10.10.2/32`

---

#### (D) Static Routeï¼ˆéå¸¸é‡è¦ï¼‰

```
Network > Virtual Routers > default > Static Routes
```

```
Destination: 10.10.10.2/32
Interface: tunnel.20
Next Hop: None
```

---

### 3-2ï¸âƒ£ Azure VMï¼ˆstrongSwanï¼‰

```bash
sudo apt install -y strongswan
```

#### `/etc/ipsec.conf`

```conf
config setup

conn paloalto
    keyexchange=ikev2
    authby=psk
    left=%any
    leftid=<AZURE_PUBLIC_IP>
    leftsubnet=10.10.10.2/32
    right=%any
    rightid=paloalto
    rightsubnet=10.1.129.4/32
    auto=start
```

#### `/etc/ipsec.secrets`

```conf
<AZURE_PUBLIC_IP> : PSK "VeryStrongSharedKey"
```

å•Ÿå‹•ï¼š

```bash
sudo ipsec restart
```

é©—è­‰ï¼š

```bash
sudo ipsec status
```

çœ‹åˆ° `INSTALLED` å³æˆåŠŸã€‚

---

## ğŸ”¹ Step 4ï¼šå®Œæˆã€Œåå‘ä»£ç†ã€ï¼ˆé—œéµï¼‰

### åœ¨ Azure VM è¨­å®š Nginx TCP Proxy

ç·¨è¼¯ï¼š

```bash
sudo nano /etc/nginx/nginx.conf
```

åŠ å…¥ï¼š

```nginx
stream {
    upstream gp_backend {
        server 10.1.129.4:443;
    }

    server {
        listen 443;
        proxy_pass gp_backend;
    }
}
```

é‡å•Ÿï¼š

```bash
sudo nginx -t
sudo systemctl restart nginx
```

---

## ğŸ”¹ Step 5ï¼šPalo Alto Security Policyï¼ˆåˆ¥æ¼ï¼‰

```
Policies > Security
```

å…è¨±ï¼š

```
Source Zone: IPSec-Zone
Destination Zone: untrust
Destination Address: 10.1.129.4
Application:
  - ssl
  - panos-global-protect
  - panos-global-protect-portal
  - panos-global-protect-gateway
Action: allow
```

---

# âœ… é©—è­‰ï¼ˆç…§é †åºï¼Œä¸€å€‹éƒ½ä¸èƒ½è·³ï¼‰

### åœ¨ Azure VMï¼š

```bash
ping 10.1.129.4
curl -k https://10.1.129.4
```

ğŸ‘‰ è¦èƒ½çœ‹åˆ° GlobalProtect Portal å›æ‡‰

---

### åœ¨å¤–éƒ¨ï¼ˆæ‰‹æ©Ÿ 4G / å®¶è£¡ï¼‰

```
https://<AZURE_PUBLIC_IP>
```

ğŸ‘‰ çœ‹åˆ° GlobalProtect Portal
ğŸ‘‰ æˆ– GlobalProtect Client èƒ½é€£ç·š

---

# ğŸ§ª æˆåŠŸå¾Œä½ æœƒå¾—åˆ°ä»€éº¼ï¼Ÿ

* âœ”ï¸ å¤–éƒ¨ä¸€å®šé€£å¾—åˆ° GlobalProtect
* âœ”ï¸ ä¸ç®¡ä½ å®¶æ˜¯ä¸æ˜¯ CGNAT
* âœ”ï¸ ä¸å½±éŸ¿ä½ ç¾åœ¨å…§éƒ¨ VPN æ¶æ§‹
* âœ”ï¸ Azure åªæ˜¯ä¸€å€‹ã€Œå…¥å£ã€

---

# âš ï¸ æ†‘è­‰èˆ‡ DNSï¼ˆä¸å½±éŸ¿æ˜¯å¦æˆåŠŸï¼‰

* æ†‘è­‰è­¦å‘Šï¼šæ­£å¸¸ï¼ˆå…ˆå¿½ç•¥ï¼‰
* æ­£å¼åšæ³•ï¼š

  ```
  vpn.yourdomain.com â†’ AZURE_PUBLIC_IP
  ```

---

# ğŸ§­ ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¹«ä½ ï¼ˆé¸ä¸€å€‹ï¼‰

1ï¸âƒ£ å¹«ä½ åšã€Œè¨­å®šå®Œæˆå¾Œçš„å®‰å…¨åŠ å›ºï¼ˆåªå…è¨± GPï¼‰ã€
2ï¸âƒ£ å¹«ä½ æŠŠ Nginx æ”¹æˆ HAProxyï¼ˆæ•ˆèƒ½æ›´å¥½ï¼‰
3ï¸âƒ£ å¹«ä½ è¨­è¨ˆæ­£å¼ DNS + æ†‘è­‰
4ï¸âƒ£ å¹«ä½ åšå®Œæ•´é©—è­‰æ¸…å–®ï¼ˆé€æ¢ checkï¼‰

ä½ é¸ä¸€å€‹ï¼Œæˆ‘ç›´æ¥æ¥è‘—å¸¶ä½ åšã€‚
